<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>VR Video Projector</title>
        <meta charset="utf-8">
    <title>Hello, WebVR! â€¢ A-Frame</title>
    <script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>

    <!-- Components and shaders go after A-Frame, but before the scene declaration. -->
    <script>
    AFRAME.registerShader('my-custom', {
      // The schema declares any parameters for the shader.
      schema: {
        src: {type:'map', is:'uniform'},
        ground: {type:'map', is:'uniform'},
      },
      
      // Setting raw to true uses THREE.RawShaderMaterial instead of ShaderMaterial,

      raw: false,
      
      /*init: function (data) {
        var videoTexture = new THREE.VideoTexture(data.src);
            
            videoTexture.minFilter = THREE.LinearMipmapLinearFilter;
            videoTexture.magFilter = THREE.LinearMipmapLinearFilter;
            videoTexture.anisotropy = 0;
            //videoTexture.format = THREE.RGBFormat;
            //videoTexture.generateMipmaps = true;
        
            var image = new THREE.Texture(data.ground);
            
            image.minFilter = THREE.LinearMipmapLinearFilter;
            image.magFilter = THREE.LinearMipmapLinearFilter;
            image.anisotropy = 2;
            //videoTexture.format = THREE.RGBFormat;
            //videoTexture.generateMipmaps = true;

        this.material = new THREE.ShaderMaterial( {
        uniforms: {
            texture: {
                type: "map",
                value: videoTexture
            },
            ground: {
                type: "map",
                value: image
            }
        },
        vertexShader: this.vertexShader,
        fragmentShader: this.fragmentShader });
      },

      update: function (data) {
        this.material.src = data.src;
        this.material.ground = data.ground;
        //this.material.transparent = data.transparent;
      },
 */
      vertexShader:
    `
      varying vec2 vUV;
      varying vec3 p;
      varying vec3 v;

      void main(void) {
        gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
        vUV = position.xy;
        p = vec3(modelViewMatrix * vec4(vec3(0.0,0.0,1.0), 0.0));
        v = vec3(modelViewMatrix * vec4(position, 1.0)) ;
      }
    `
    ,
      fragmentShader: 
    `
      precision mediump float;

      uniform sampler2D src;
      uniform sampler2D ground;
      varying vec2 vUV;
      varying vec3 p;
      varying vec3 v;

      //uniform float opacity;

      void main () {
        vec3 sandColor = texture2D(ground,vec2(vUV.x,vUV.y)*0.2).rgb;
        vec3 lightColor = vec3(0.042,0.067,0.075)*2.0;
        lightColor += texture2D(src,vec2(0.5,0.5),4.0).rgb*0.05;


        float vignette = 1.0-pow(max(1.0-dot(normalize(-v),normalize(p)),0.0)*2.0,1.0);

        gl_FragColor = vec4(sandColor*lightColor*vignette, 1.0);
      }
    `
    });
    </script>

    <style type="text/css">
      #video-permission {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: white;
          z-index: 10000;
          display: none;
      }

      #video-permission-button {
        position: fixed;
        top: calc(50% - 1em);
        left: calc(50% - 60px);
        width: 120px;
        height: 2em;
      }

      #play-button {
        position: fixed;
        top: calc(50% - 1em);
        left: calc(50% - 2em);
        width: 4em;
        height: 2em;
        z-index: 10;
      }
    </style>

  </head>
  <body>

    <div id="video-permission">
      <button id="video-permission-button">Allow VR video</button>
    </div>

    <button id="play-button">Play</button>


    <a-scene fog="type: linear; near:1; far:600; color: #000000;"><!--Night mode: #0c192a-->


      <a-assets>
        <img id="grid"
             src="https://raw.githubusercontent.com/martinsh/aframe-video-johansons/master/assets/white_grid.png"
             crossorigin="anonymous">
        
         <img id="ground"
             src="https://raw.githubusercontent.com/martinsh/aframe-video-johansons/master/assets/beach.png"
             crossorigin="anonymous">
        
        <video id="video-src" 
               loop="true" 
               repeat="true"
               src="https://raw.githubusercontent.com/martinsh/aframe-video-johansons/master/assets/THIRST.mp4"
               crossorigin="anonymous" webkit-playsinline></video>
      </a-assets>


      <!-- VR CONTROLLERS -->
      <a-entity oculus-touch-controls="hand: left"></a-entity>
      <a-entity oculus-touch-controls="hand: right"></a-entity>
      <!-- END VR CONTROLLERS -->

      <!-- MEDIAS HOLDER -->
      <a-video id="video-screen" src="#video-src" position="0 4.5 -9" width="19.2" height="8.04"></a-video>
      <!-- END MEDIAS HOLDER -->

      <script>
      var vid = document.getElementById('video-src');
        
      //var texture = new THREE.VideoTexture( vid );
      //texture.minFilter = THREE.LinearFilter;
      //texture.magFilter = THREE.LinearFilter;
      //texture.format = THREE.RGBFormat;
      console.log(vid);

      document.getElementById('play-button').addEventListener("click", function(e){
        this.style.display = 'none';
        vid.play();
      }, false);
      </script>

      <!-- ENVIRONMENT -->
      
      <!-- <a-box
          depth="-18.1" height="10.1" width="20" position="0 5 0"
          material="shader:my-custom; src:#video-src ;repeat: 10000 10000; ground:#ground; transparent:false"></a-box> -->
      
      <a-entity
          geometry="primitive: plane; width: 10000; height: 10000;" rotation="-90 0 0" position="0 -0.1 0"
          material="shader:my-custom; src:#video-src ;repeat: 10000 10000; ground:#ground; transparent:false"></a-entity>


      <a-entity
          geometry="primitive: plane; width: 10000; height: 10000;" rotation="-90 0 0"
          material="src: #grid; repeat: 10000 10000; transparent: true; opacity:0.2;"></a-entity>

      <a-sky color="#040404"></a-sky>

      <!--<a-entity light="type: point; color: #133255; intensity: 0.75; distance: 50; decay: 2" position="0 4.5 0"></a-entity>-->


      <!-- END ENVIRONMENT --> 
    </a-scene>

  </body>
</html>
